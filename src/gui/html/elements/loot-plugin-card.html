<!-- Fires the following events:

loot-editor-open

loot-filter-conflicts
  detail: boolean
    True if the filter has been activated.

loot-copy-metadata

loot-clear-metadata
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="loot-plugin-editor.html">
<link rel="import" href="loot-custom-icons.html">

<dom-module id="loot-plugin-card">
    <template>
        <style>
        /* Host and front/editor styling. */
        #wrapper {
            display: block;
            background: white;
            margin: 0 8px 8px 8px;
            position: relative;
            transition: 0.6s;
            transform-style: preserve-3d;
        }
        :host(.highlight) #wrapper {
            outline: 4px solid #64B5F6;
        }
        :host([is-search-result]) #front,
        :host([is-search-result]) #editor {
            box-shadow: inset 4px 0 #3F51B5;
        }
        #front {
            display: block;
            backface-visibility: hidden;
        }
        #editor {
            transform: rotateY(180deg);
            display:none;
            backface-visibility: hidden;
        }

        /* Flip animation styling. */
        :host(.flip) #wrapper {
            transform: rotateY(180deg);
        }
        :host(.flip) #front  {
            display: none;
        }
        :host(.flip) #editor  {
            display: block;
        }
        :host(.fastflip) #wrapper {
            transition-duration: 1ms;
        }

        /* Icon styling. */
        iron-icon {
            color: rgba(0, 0, 0, 0.54);
            padding: 8px;
        }
        #activeTick {
            color: green;
        }
        :host(:not([is-active])) #activeTick {
            visibility: hidden;
        }

        /* Content styling. */
        content::content > .tag {
            display: block;
            padding: 0 16px 16px;
        }
        content::content > ul {
            display: block;
            padding: 0 16px 16px 40px;
            margin: 0;
        }
        content::content > h1 {
            font-size: 1.143rem;
            display: inline-block;
            margin: 0;
            color: inherit;
        }
        content::content > .version,
        content::content > .crc {
            display: inline-block;
            margin-left: 16px;
            font-weight: 400;
            font-size: 1rem;
        }
        :host-context(#main[data-hide-crc]) content::content > .crc,
        :host-context(#main[data-hide-tag]) content::content > .tag,
        :host-context(#main[data-hide-version]) content::content > .version {
            display: none;
        }

        /* Misc Styling. */
        paper-toolbar {
            --paper-toolbar-color: rgba(0, 0, 0, 0.87);
            --paper-toolbar-background: inherit;
            height: 56px;
        }
        paper-toolbar::shadow #topBar {
            height: 56px;
        }
        #content {
            overflow: hidden;
        }
        #title {
            @apply(--layout-flex);
            overflow: hidden;
            white-space: nowrap;
        }
        #conflictsLabel {
            white-space: nowrap;
        }
        #conflictsLabel,
        #editMetadata,
        #copyMetadata,
        #clearMetadata {
            cursor: pointer;
        }
        </style>
        <paper-material id="wrapper" elevation="1">
            <section id="front">
                <paper-toolbar>
                    <iron-icon id="activeTick" icon="check"></iron-icon>
                    <paper-tooltip for="activeTick">Active Plugin</paper-tooltip>
                    <div id="title">
                        <content select="h1"></content>
                        <content select=".version"></content>
                        <content select=".crc"></content>
                    </div>
                    <iron-icon id="isMaster" icon="loot-custom-icons:crown" hidden$="[[!isMaster]]"></iron-icon>
                    <paper-tooltip for="isMaster">Master File</paper-tooltip>
                    <iron-icon id="emptyPlugin" icon="visibility-off" hidden$="[[!isEmpty]]"></iron-icon>
                    <paper-tooltip for="emptyPlugin">Empty Plugin</paper-tooltip>
                    <iron-icon id="loadsBSA" icon="attachment" hidden$="[[!hasBsa]]"></iron-icon>
                    <paper-tooltip for="loadsBSA">Loads BSA</paper-tooltip>
                    <iron-icon id="hasUserEdits" icon="account-circle" hidden$="[[!hasUserEdits]]"></iron-icon>
                    <paper-tooltip for="hasUserEdits">Has User Metadata</paper-tooltip>
                    <paper-menu-button id="menu" opened="{{data.isMenuOpen}}" horizontal-align="right">
                        <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                        <div class="dropdown-content">
                            <paper-icon-item id="conflictsLabel">
                                <paper-toggle-button id="showOnlyConflicts" checked="{{data.isConflictFilterChecked}}" item-icon></paper-toggle-button>
                                <div>Show Only Conflicts</div>
                            </paper-icon-item>
                            <paper-icon-item id="editMetadata">
                                <iron-icon icon="create" item-icon></iron-icon>
                                Edit Metadata
                            </paper-icon-item>
                            <paper-icon-item id="copyMetadata">
                                <iron-icon icon="content-copy" item-icon></iron-icon>
                                Copy Metadata
                            </paper-icon-item>
                            <paper-icon-item id="clearMetadata">
                                <iron-icon icon="delete" item-icon></iron-icon>
                                Clear User Metadata
                            </paper-icon-item>
                        </div>
                    </paper-menu-button>
                </paper-toolbar>
                <div id="content">
                    <content select=".tag.add"></content>
                    <content select=".tag.remove"></content>
                    <content></content>
                </div>
            </section>
            <loot-plugin-editor id="editor">
                <h1>[[data.name]]</h1>
                <span class="version">[[data.version]]</span>
                <span class="crc">[[data.crc]]</span>
            </loot-plugin-editor>
        </paper-material>
    </template>
    <script>
    Polymer({
        is: 'loot-plugin-card',
        properties: {
            data: {
                notify: true,
                observer: '_dataChanged'
            },
            isActive: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            },
            isMaster: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            },
            isEmpty: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            },
            hasBsa: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            },
            hasUserEdits: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            },
            isSearchResult: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
            }
        },

        attached: function() {
            this.$.conflictsLabel.addEventListener('click', this._onConflictsLabelClick, false);
            this.$.showOnlyConflicts.addEventListener('iron-change', this._onShowOnlyConflicts, false);
            this.$.editMetadata.addEventListener('click', this._onShowEditor, false);
            this.$.copyMetadata.addEventListener('click', this._onCopyMetadata, false);
            this.$.clearMetadata.addEventListener('click', this._onClearMetadata, false);

            this.addEventListener('paper-dropdown-open', this._onMenuToggle, false);

            this.addEventListener('transitionend', this._onFlipEnd, false);
        },

        detached: function() {
            this.$.conflictsLabel.removeEventListener('click', this._onConflictsLabelClick, false);
            this.$.showOnlyConflicts.removeEventListener('iron-change', this._onShowOnlyConflicts, false);
            this.$.editMetadata.removeEventListener('click', this._onShowEditor, false);
            this.$.copyMetadata.removeEventListener('click', this._onCopyMetadata, false);
            this.$.clearMetadata.removeEventListener('click', this._onClearMetadata, false);

            this.removeEventListener('paper-dropdown-open', this._onMenuToggle, false);

            this.removeEventListener('transitionend', this._onFlipEnd, false);
        },

        _dataChanged: function(newValue, oldValue) {
            if (newValue) {
                if (newValue.isEditorOpen) {
                    /* Record existing data. */
                    if (oldValue) {
                        oldValue.editor = this.readFromEditor(oldValue);
                    }
                    /* Share the data with the editor. */
                    this.$.editor.setEditorData(newValue);
                }

                /* Set the card flip state. */
                if (this.classList.contains('flip') != newValue.isEditorOpen) {
                    /* Temporarily speed up the flip effect, as otherwise fast
                       scrolling lets the user see the end of it. */
                    this.classList.add('fastflip');
                    this.classList.toggle('flip');
                }

                /* Also set highlight if the conflict filter is active. */
                this.classList.toggle('highlight', newValue.isConflictFilterChecked);
            }
        },

        _onMenuToggle: function(evt) {
            if (evt.type == 'paper-dropdown-open') {
                evt.currentTarget.style.marginBottom = '190px';
            } else {
                evt.currentTarget.style.marginBottom = '0';
            }
        },

        getName: function() {
            return this.getElementsByTagName('h1')[0].textContent;
        },

        _onFlipEnd: function(evt) {
            /* Remove fastflip class if present. */
            this.classList.remove('fastflip');
        },

        _onShowEditor: function(evt) {
            var card;
            if (this.tagName == 'LOOT-PLUGIN-CARD') {
                card = this;
            } else {
                card = getMenuItemCard(this);
            }

            /* If the editor hasn't already been opened, its data is not yet set, so do that now. */
            if (!card.data.isEditorOpen && !card.data.editor) {
                card.$.editor.setEditorData(card.data);
            }

            card.data.isEditorOpen = true;

            /* Fire an open event, so that the UI can enter edit mode. */
            card.dispatchEvent(new CustomEvent('loot-editor-open'));
            card.$.menu.close();
        },

        readFromEditor: function(oldData) {
            return this.$.editor.readFromEditor(oldData);
        },

        _onConflictsLabelClick: function(evt) {
            /* Toggle the toggle state if the user didn't. */
            if (evt.target.id != 'showOnlyConflicts') {
                var toggle = evt.currentTarget.querySelector('#showOnlyConflicts');
                /* Don't toggle state if the click event fires when dragging the
                   toggle button and the mouse has ended up outside of the
                   toggle button element. */
                if (!toggle.pressed) {
                    toggle.checked = !toggle.checked;
                }
            }
        },

        _onShowOnlyConflicts: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-filter-conflicts', {
                detail: evt.currentTarget.checked
            }));
            evt.currentTarget.parentElement.parentElement.parentElement.close();
        },

        _onCopyMetadata: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-copy-metadata'));
            evt.currentTarget.parentElement.parentElement.close();
        },

        _onClearMetadata: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-clear-metadata'));
            evt.currentTarget.parentElement.parentElement.close();
        }
    });

    function getMenuItemCard(element) {
        while (element.parentElement) {
            element = element.parentElement;
        }
        return element.parentNode.host;
    }
    </script>
</dom-module>
